# Dockerize Vistalabâ€™s pbrt-v4 for CPU only.

# CPU only -- much smaller docker image
# Used for assimp and exr2bin even when running with remote GPU
FROM ubuntu:22.04

MAINTAINER Zhenyi Liu <zhenyiliu@stanford.edu>
MAINTAINER David Cardinal <david.cardinal@stanford.edu>

ENV DEBIAN_FRONTEND=noninteractive

# Install a higher version of cmake
RUN apt-get update -yq && \
apt-get install -yq software-properties-common && \
add-apt-repository ppa:graphics-drivers && \
add-apt-repository -y ppa:ubuntu-toolchain-r/test && \
apt-get update

# add debugging tools
RUN apt-get update -yq && apt-get install -yq --no-install-recommends \
	bash \
	cmake \
	libgl1-mesa-dev \
	libxrandr-dev \
	libxinerama-dev \
	libxcursor-dev \
	libxi-dev \
	build-essential \
	gcc-9 \
	g++-9 \
	make \
	bison \
	flex \
	libpthread-stubs0-dev \
	zlib1g-dev \
	libgsl-dev \
	libssl-dev \
	doxygen \
	wget \
       apt-utils \
       ca-certificates \
       curl && \
    rm -rf /var/lib/apt/lists/*


# Setup folder structure
RUN mkdir /pbrt
WORKDIR /pbrt/

# Pull the git repos and make them
# added ldconfig as otherwise assimp can't always find its .so
RUN apt-get update -yq && apt-get install -y git \
&& git clone -b master --recursive https://github.com/scienstanford/pbrt-v4.git \
&& git clone https://github.com/Zhenyi-Liu/assimp.git \
&& cd assimp \
&& mkdir build \
&& cd build \
&& cmake .. \
&& make -j8 \
&& make install

# try to build-in libs -- but they may need to be symlinked for this to work
WORKDIR /pbrt/pbrt-v4/build
RUN cmake -DCMAKE_BUILD_TYPE=MINSIZEREL .. \
&& make -j12

ENV PATH=$PATH:/pbrt/pbrt-v4/build

